---
/**
 * ExitIntentPopup - Desktop Ã‡Ä±kÄ±ÅŸ Popup'Ä±
 *
 * ðŸ“Š Bilimsel Dayanaklar:
 * - Exit intent captures ~10-15% of abandoning visitors (Sleeknote, 2021)
 * - 24h cooldown prevents annoyance (best practice)
 * - Single CTA = 371% more clicks than multiple (Unbounce)
 */

const phoneNumber = "05336157835";
---

<!-- Exit Intent Popup - Desktop Only -->
<div
    id="exit-intent-popup"
    class="exit-popup fixed inset-0 z-[99998] hidden lg:block"
    style="display: none;"
    role="dialog"
    aria-modal="true"
    aria-labelledby="exit-popup-title"
>
    <!-- Backdrop -->
    <div
        class="popup-backdrop absolute inset-0 bg-black/70 backdrop-blur-sm opacity-0 transition-opacity duration-300"
    >
    </div>

    <!-- Popup Content -->
    <div
        class="popup-content absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-gradient-to-br from-slate-900 to-slate-950 rounded-3xl p-8 shadow-2xl border border-white/10 opacity-0 scale-95 transition-all duration-300"
    >
        <!-- Close Button -->
        <button
            id="exit-popup-close"
            class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 rounded-full transition-all"
            aria-label="Kapat"
        >
            <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Icon -->
        <div
            class="w-20 h-20 mx-auto mb-6 bg-orange-500/10 rounded-2xl flex items-center justify-center border border-orange-500/20"
        >
            <svg
                class="w-10 h-10 text-orange-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
            </svg>
        </div>

        <!-- Title -->
        <h3
            id="exit-popup-title"
            class="text-2xl md:text-3xl font-hero-alt text-white text-center mb-4 tracking-widest uppercase"
        >
            Gitmeden Ã–nce!
        </h3>

        <!-- Subtitle -->
        <p class="text-slate-400 text-center mb-8 text-lg">
            <span class="text-orange-400 font-semibold"
                >Ãœcretsiz arÄ±za teÅŸhisi</span
            > iÃ§in hemen randevu alÄ±n. Uzman ekibimiz aracÄ±nÄ±zÄ± deÄŸerlendirsin.
        </p>

        <!-- Single CTA (Unbounce: 371% more clicks) -->
        <a
            href={`tel:${phoneNumber}`}
            id="exit-popup-cta"
            class="group flex items-center justify-center gap-4 w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-5 px-8 rounded-2xl font-button text-lg tracking-widest transition-all duration-300 shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 hover:-translate-y-1"
        >
            <svg
                class="w-6 h-6 group-hover:rotate-12 transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                ></path>
            </svg>
            <span>Ãœcretsiz Randevu Al</span>
        </a>

        <!-- No Thanks -->
        <button
            id="exit-popup-dismiss"
            class="w-full mt-4 py-3 text-slate-500 hover:text-slate-300 text-sm font-button tracking-widest transition-colors"
        >
            HayÄ±r, teÅŸekkÃ¼rler
        </button>
    </div>
</div>

<style>
    .exit-popup.is-open {
        display: block !important;
    }

    .exit-popup.is-open .popup-backdrop {
        opacity: 1;
    }

    .exit-popup.is-open .popup-content {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
</style>

<script>
    const COOLDOWN_KEY = "exit_intent_shown";
    const COOLDOWN_HOURS = 24;
    const SCROLL_THRESHOLD = 0.3; // User must scroll at least 30%

    let hasScrolled = false;
    let popupShown = false;

    function isDesktop(): boolean {
        return window.innerWidth >= 1024;
    }

    function isOnCooldown(): boolean {
        const lastShown = localStorage.getItem(COOLDOWN_KEY);
        if (!lastShown) return false;

        const hoursSince =
            (Date.now() - parseInt(lastShown)) / (1000 * 60 * 60);
        return hoursSince < COOLDOWN_HOURS;
    }

    function setCooldown(): void {
        localStorage.setItem(COOLDOWN_KEY, Date.now().toString());
    }

    function showPopup(): void {
        if (popupShown || !isDesktop() || isOnCooldown() || !hasScrolled)
            return;

        const popup = document.getElementById("exit-intent-popup");
        if (!popup) return;

        popupShown = true;
        popup.classList.add("is-open");
        document.body.style.overflow = "hidden";
        setCooldown();

        // Track
        if (typeof (window as any).gtag !== "undefined") {
            (window as any).gtag("event", "exit_intent_shown", {
                page_path: window.location.pathname,
                scroll_depth: Math.round(
                    (window.scrollY /
                        (document.body.scrollHeight - window.innerHeight)) *
                        100,
                ),
            });
        }
    }

    function hidePopup(): void {
        const popup = document.getElementById("exit-intent-popup");
        if (!popup) return;

        popup.classList.remove("is-open");
        document.body.style.overflow = "";
    }

    // Track scroll depth
    window.addEventListener(
        "scroll",
        () => {
            const scrollDepth =
                window.scrollY /
                (document.body.scrollHeight - window.innerHeight);
            if (scrollDepth >= SCROLL_THRESHOLD) {
                hasScrolled = true;
            }
        },
        { passive: true },
    );

    // Exit intent detection (mouse leaves viewport from top)
    document.addEventListener("mouseleave", (e) => {
        if (e.clientY <= 0) {
            showPopup();
        }
    });

    // Close handlers
    document
        .getElementById("exit-popup-close")
        ?.addEventListener("click", hidePopup);
    document
        .getElementById("exit-popup-dismiss")
        ?.addEventListener("click", hidePopup);
    document
        .querySelector(".popup-backdrop")
        ?.addEventListener("click", hidePopup);

    // Track CTA click
    document.getElementById("exit-popup-cta")?.addEventListener("click", () => {
        if (typeof (window as any).gtag !== "undefined") {
            (window as any).gtag("event", "exit_intent_conversion", {
                action: "phone_call",
            });
        }
        hidePopup();
    });

    // Escape key
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hidePopup();
    });
</script>
