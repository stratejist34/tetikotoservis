---
// RevCounter.astro - Tachometer Micro-Interaction Component
---

<script>
  // Client-side script - GSAP dinamik import
  if (typeof window !== 'undefined') {
    console.log('RevCounter mounted');
    
    // GSAP ve ScrollTrigger'u dinamik olarak yükle
    Promise.all([
      import('gsap'),
      import('gsap/ScrollTrigger')
    ]).then(([gsapModule, ScrollTriggerModule]) => {
      const gsap = gsapModule.gsap;
      const ScrollTrigger = ScrollTriggerModule.ScrollTrigger;
      
      gsap.registerPlugin(ScrollTrigger);

      // Elementleri bul
      const needle = document.querySelector('.rev-counter .needle');
      const rpmText = document.querySelector('.rev-counter .rpm-text');
      const gauge = document.querySelector('.rev-counter');

      console.log('Elements found:', { needle, rpmText, gauge });

      // RPM sayısını güncelleme
      const updateRPM = (progress: number) => {
        const rpm = Math.round(progress * 7000 + 1000); // 1000'den 8000'e
        if (rpmText) {
          rpmText.textContent = `${Math.floor(rpm / 1000)} RPM`;
        }
      };

      // ScrollTrigger konfigürasyonu
      ScrollTrigger.create({
        trigger: 'body',
        start: 'top top',
        end: '300px top',
        scrub: true,
        onUpdate: (self) => {
          // Progress değerine göre iğneyi ve RPM sayısını güncelle
          const progress = self.progress;
          if (needle) {
            gsap.to(needle, {
              rotation: -135 + (progress * 135),
              transformOrigin: '50% 50%',
              ease: 'power2.out',
              duration: 0.1
            });
          }
          updateRPM(progress);
        },
        onEnter: () => {
          // Scroll başladığında hafif bir "gas sesi" efekti
          if (rpmText) {
            rpmText.classList.add('pulsing');
            setTimeout(() => {
              if (rpmText) rpmText.classList.remove('pulsing');
            }, 300);
          }
        }
      });

      // Mouse over interactivity
      if (gauge && needle) {
        gauge.addEventListener('mouseenter', () => {
          gsap.to(needle, {
            rotation: -45,
            transformOrigin: '50% 50%',
            ease: 'power2.out',
            duration: 0.5
          });
          if (rpmText) {
            rpmText.textContent = '6 RPM';
          }
        });

        gauge.addEventListener('mouseleave', () => {
          gsap.to(needle, {
            rotation: -135,
            transformOrigin: '50% 50%',
            ease: 'power2.in',
            duration: 0.5
          });
          if (rpmText) {
            rpmText.textContent = '1 RPM';
          }
        });
      }

      // Başlangıç pozisyonu
      if (needle) {
        gsap.set(needle, { rotation: -135 });
      }
      updateRPM(0);
    }).catch(error => {
      console.error('GSAP yüklenirken hata:', error);
    });
  }
</script>

<style>
  .rev-counter {
    position: absolute;
    width: 200px;
    height: 200px;
    filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.8));
    pointer-events: auto;
    visibility: visible;
    opacity: 1;
    z-index: 99999;
    display: block;
  }
  
  .gauge-bg {
    fill: url(#gaugeGradient);
    stroke: rgba(255, 255, 255, 0.15);
    stroke-width: 3;
  }

  .tick {
    stroke: rgba(255, 255, 255, 0.7);
    stroke-width: 2.5;
    stroke-linecap: round;
  }

  .tick.red {
    stroke: #ff4757;
    stroke-width: 3.5;
    filter: drop-shadow(0 0 8px rgba(255, 71, 87, 0.5));
  }

  .needle {
    stroke: #ff6b6b;
    stroke-width: 4.5;
    filter: drop-shadow(0 3px 6px rgba(255, 107, 107, 0.6));
    transform-box: fill-box;
    transform-origin: 50% 50%;
    transition: stroke 0.3s ease;
  }

  .needle:hover {
    stroke: #ffd166;
  }

  .center-circle {
    fill: url(#centerGradient);
    stroke: rgba(255, 255, 255, 0.25);
    stroke-width: 2.5;
  }

  .rpm-text {
    font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 800;
    font-size: 28px;
    fill: #ffffff;
    text-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
  }

  .gear-text {
    font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 700;
    font-size: 16px;
    fill: rgba(255, 255, 255, 0.9);
  }

  .tetik-logo {
    font-family: 'Bebas Neue', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 900;
    font-size: 20px;
    fill: #ffd166;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .glass-effect {
    fill: url(#glassGradient);
    opacity: 0.35;
  }

  /* Animasyon efekti */
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .rpm-text.pulsing {
    animation: pulse 0.3s ease;
  }
</style>

<div class="rev-counter">
  <svg xmlns="http://www.w3.org/2000/svg" style="visibility: visible; opacity: 1;">
    <defs>
      <!-- Ana gauge gradient -->
      <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#1f2937"/>
        <stop offset="50%" stop-color="#111827"/>
        <stop offset="100%" stop-color="#0b1220"/>
      </linearGradient>

      <!-- Center circle gradient -->
      <radialGradient id="centerGradient" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#1f2937"/>
        <stop offset="70%" stop-color="#0f172a"/>
        <stop offset="100%" stop-color="#0b1220"/>
      </radialGradient>

      <!-- Glass effect gradient -->
      <linearGradient id="glassGradient" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="white" stop-opacity="0.3"/>
        <stop offset="50%" stop-color="white" stop-opacity="0.1"/>
        <stop offset="100%" stop-color="white" stop-opacity="0"/>
      </linearGradient>
    </defs>

    <!-- Glass effect overlay -->
    <ellipse class="glass-effect" cx="150" cy="150" rx="120" ry="120" visibility="visible"/>

    <!-- Main gauge arc -->
    <path class="gauge-bg" d="
      M 30 220
      A 120 120 0 0 1 270 220
    "/>

    <!-- Red zone background -->
    <path class="tick red" d="
      M 250 240
      A 120 120 0 0 1 270 200
    " stroke-width="12" opacity="0.3"/>

    <!-- Ticks (0-8) -->
    <!-- 0 -->
    <line class="tick" x1="30" y1="220" x2="45" y2="220"/>
    <!-- 1 -->
    <line class="tick" x1="60" y1="240" x2="72" y2="235"/>
    <!-- 2 -->
    <line class="tick" x1="95" y1="255" x2="105" y2="248"/>
    <!-- 3 -->
    <line class="tick" x1="135" y1="265" x2="143" y2="258"/>
    <!-- 4 -->
    <line class="tick" x1="175" y1="265" x2="183" y2="258"/>
    <!-- 5 -->
    <line class="tick" x1="215" y1="255" x2="225" y2="248"/>
    <!-- 6 -->
    <line class="tick" x1="250" y1="240" x2="262" y2="235"/>
    <!-- 7 -->
    <line class="tick red" x1="270" y1="220" x2="270" y2="205"/>
    <!-- 8 (Redline) -->
    <line class="tick red" x1="270" y1="200" x2="270" y2="185"/>

    <!-- Needle -->
    <line class="needle" x1="150" y1="150" x2="150" y2="60"/>

    <!-- Needle pivot -->
    <circle cx="150" cy="150" r="6" fill="#ffd166" stroke="rgba(255,255,255,0.5)" stroke-width="2"/>

    <!-- Center circle -->
    <circle class="center-circle" cx="150" cy="150" r="20"/>

    <!-- Digital display -->
    <text class="rpm-text" x="150" y="135" text-anchor="middle">1 RPM</text>
    <text class="gear-text" x="150" y="155" text-anchor="middle">GEAR 1</text>
    <text class="tetik-logo" x="150" y="175" text-anchor="middle">TETİK</text>

    <!-- Subtle glow -->
    <circle cx="150" cy="150" r="140" fill="none" stroke="rgba(255,209,102,0.1)" stroke-width="2"/>
  </svg>
</div>