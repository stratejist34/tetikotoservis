---
interface Props {
    showTooltips?: boolean;
    onlyFirstVisit?: boolean;
}

const { showTooltips = true, onlyFirstVisit = true } = Astro.props;
const phoneNumber = "05336157835";
const whatsappNumber = "905336157835";
const whatsappMessage = encodeURIComponent(
    "Merhaba, araÃ§ servisi hakkÄ±nda bilgi almak istiyorum",
);
---

<div
    class="sticky-contact-wrapper"
    data-tooltips={showTooltips}
    data-first-visit={onlyFirstVisit}
>
    <!-- Phone Button (Ãœstte) -->
    <a
        href={`tel:${phoneNumber}`}
        class="sticky-btn sticky-phone-btn"
        aria-label="Telefon ile ara"
        title="Hemen arayÄ±n"
        data-btn-type="phone"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
            ></path>
        </svg>
        <span class="btn-tooltip phone-tooltip" aria-hidden="true"></span>
    </a>

    <!-- WhatsApp Button (Altta) -->
    <a
        href={`https://wa.me/${whatsappNumber}?text=${whatsappMessage}`}
        class="sticky-btn sticky-whatsapp-btn"
        aria-label="WhatsApp ile iletiÅŸime geÃ§"
        title="WhatsApp'tan yazÄ±n"
        target="_blank"
        rel="noopener noreferrer"
        data-btn-type="whatsapp"
    >
        <!-- Orijinal WhatsApp Ä°konu -->
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="#ffffff"
        >
            <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
            ></path>
        </svg>
        <span class="btn-tooltip whatsapp-tooltip" aria-hidden="true"></span>
    </a>
</div>

<script>
    function initContactTooltips() {
        const wrapper = document.querySelector(
            ".sticky-contact-wrapper",
        ) as HTMLElement;
        if (!wrapper) return;

        const showTooltips = wrapper.dataset.tooltips === "true";
        const onlyFirstVisit = wrapper.dataset.firstVisit === "true";
        const whatsappTooltip = wrapper.querySelector(
            ".whatsapp-tooltip",
        ) as HTMLElement;
        const phoneTooltip = wrapper.querySelector(
            ".phone-tooltip",
        ) as HTMLElement;
        const whatsappBtn = wrapper.querySelector(
            ".sticky-whatsapp-btn",
        ) as HTMLElement;
        const phoneBtn = wrapper.querySelector(
            ".sticky-phone-btn",
        ) as HTMLElement;

        if (!showTooltips || !whatsappTooltip || !phoneTooltip) return;

        // localStorage kontrolÃ¼
        const storageKey = "contact_tooltips_shown_v2";
        if (onlyFirstVisit && localStorage.getItem(storageKey)) return;

        // Device Detection (sadece 1 kere)
        const isIPhone = /iPhone/.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const deviceType = isIPhone ? "iPhone" : isIOS ? "iPad" : "other";

        // Zamanlama ayarlarÄ± (iPhone iÃ§in daha hÄ±zlÄ±)
        const timings = {
            first: isIPhone ? 2000 : 3000,
            second: isIPhone ? 5000 : 7000,
            duration: 3000,
        };

        // Mesajlar (cihaza gÃ¶re)
        const messages = isIPhone
            ? {
                  first: { text: "ðŸ’¬ WhatsApp'tan YazÄ±n", target: "whatsapp" },
                  second: { text: "ðŸ“ž Veya Hemen Ara", target: "phone" },
                  footer: {
                      text: "ðŸŽ Ãœcretsiz Fiyat Teklifi",
                      target: "phone",
                  },
              }
            : {
                  first: { text: "ðŸ‘¨â€ðŸ”§ Ustaya Sor", target: "whatsapp" },
                  second: { text: "ðŸ“ž Hemen Ara", target: "phone" },
                  footer: { text: "ðŸ’° Fiyat Al", target: "phone" },
              };

        let footerShown = false;
        let tooltipShowTimes: { [key: string]: number } = {};

        // Analytics tracking helper
        function trackTooltip(message: string, timing: string, target: string) {
            tooltipShowTimes[target] = Date.now();
            if (typeof (window as any).gtag !== "undefined") {
                (window as any).gtag("event", "tooltip_shown", {
                    device_type: deviceType,
                    tooltip_message: message,
                    tooltip_timing: timing,
                    button_target: target,
                });
            }
        }

        // Tooltip gÃ¶sterme fonksiyonu
        function showTooltip(
            tooltip: HTMLElement,
            text: string,
            duration: number,
            timing: string,
            target: string,
        ) {
            tooltip.textContent = text;
            tooltip.classList.add("visible");
            trackTooltip(text, timing, target);
            setTimeout(() => tooltip.classList.remove("visible"), duration);
        }

        // Ä°lk tooltip (WhatsApp'a iÅŸaret)
        setTimeout(() => {
            if (!footerShown) {
                const tooltip =
                    messages.first.target === "whatsapp"
                        ? whatsappTooltip
                        : phoneTooltip;
                showTooltip(
                    tooltip,
                    messages.first.text,
                    timings.duration,
                    isIPhone ? "2s" : "3s",
                    messages.first.target,
                );
            }
        }, timings.first);

        // Ä°kinci tooltip (Telefon'a iÅŸaret)
        setTimeout(() => {
            if (!footerShown) {
                const tooltip =
                    messages.second.target === "whatsapp"
                        ? whatsappTooltip
                        : phoneTooltip;
                showTooltip(
                    tooltip,
                    messages.second.text,
                    timings.duration,
                    isIPhone ? "5s" : "7s",
                    messages.second.target,
                );
            }
        }, timings.second);

        // Footer tooltip (Scroll %90)
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting && !footerShown) {
                        footerShown = true;
                        const tooltip =
                            messages.footer.target === "whatsapp"
                                ? whatsappTooltip
                                : phoneTooltip;
                        showTooltip(
                            tooltip,
                            messages.footer.text,
                            timings.duration,
                            "footer",
                            messages.footer.target,
                        );
                        observer.disconnect();
                    }
                });
            },
            { threshold: 0.1 },
        );

        const footer = document.querySelector("footer");
        if (footer) observer.observe(footer);

        // Buton tÄ±klama tracking
        function trackClick(btnType: string) {
            const showTime = tooltipShowTimes[btnType];
            const timeElapsed = showTime
                ? Math.round((Date.now() - showTime) / 1000)
                : 0;

            if (typeof (window as any).gtag !== "undefined") {
                (window as any).gtag("event", "contact_button_click", {
                    device_type: deviceType,
                    button_type: btnType,
                    time_after_tooltip: timeElapsed,
                });
            }
        }

        whatsappBtn?.addEventListener("click", () => trackClick("whatsapp"));
        phoneBtn?.addEventListener("click", () => trackClick("phone"));

        // Ä°lk ziyaret olarak iÅŸaretle
        if (onlyFirstVisit) {
            localStorage.setItem(storageKey, "true");
        }
    }

    // Init
    if (document.readyState === "complete") {
        setTimeout(initContactTooltips, 100);
    } else {
        window.addEventListener(
            "load",
            () => setTimeout(initContactTooltips, 100),
            { once: true },
        );
    }
    document.addEventListener("astro:page-load", () =>
        setTimeout(initContactTooltips, 100),
    );
</script>

<style>
    .sticky-contact-wrapper {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Desktop'ta sol altta */
    @media (min-width: 768px) {
        .sticky-contact-wrapper {
            left: 20px;
            right: auto;
            bottom: 30px;
        }
    }

    .sticky-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        color: #ffffff;
        text-decoration: none;
        position: relative;
    }

    .sticky-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
    }

    .sticky-btn svg {
        width: 24px;
        height: 24px;
        stroke: #ffffff;
    }

    /* WhatsApp Button */
    .sticky-whatsapp-btn {
        background-color: #25d366;
    }

    .sticky-whatsapp-btn:hover {
        background-color: #20bd5a;
    }

    /* Phone Button */
    .sticky-phone-btn {
        background-color: #ea580c;
    }

    .sticky-phone-btn:hover {
        background-color: #c2410c;
    }

    /* Tooltips */
    .btn-tooltip {
        position: absolute;
        left: 70px;
        top: 50%;
        transform: translateY(-50%) translateX(-10px);
        background: #1e293b;
        color: #fff;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        pointer-events: none;
    }

    .btn-tooltip::before {
        content: "";
        position: absolute;
        left: -6px;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-right-color: #1e293b;
        border-left: none;
    }

    .btn-tooltip.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(-50%) translateX(0);
    }

    /* Pulse animation for attention */
    @keyframes pulse-ring {
        0% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4);
        }
        70% {
            box-shadow: 0 0 0 12px rgba(37, 211, 102, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
        }
    }

    .sticky-whatsapp-btn {
        animation: pulse-ring 2s ease-out infinite;
        animation-delay: 1s;
    }
</style>
