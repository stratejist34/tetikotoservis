---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';

// ✅ Schema component'leri
import BlogPostingSchema from '../../components/BlogPostingSchema.astro';
import FAQSchema from '../../components/FAQSchema.astro';
import BreadcrumbSchema from '../../components/BreadcrumbSchema.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { slug } = Astro.params;
const { entry } = Astro.props;
const { Content } = await entry.render();

// Schema URL & Breadcrumb
const currentUrl = `${Astro.site || 'https://hyundaiservisim.com'}/blog/${slug}`;
const breadcrumbItems = [
  { name: 'Anasayfa', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: entry.data.title, url: `/blog/${slug}` }
];

// TOC Extraction Logic (Server Side)
const headings = [];
const content = await entry.body;
const lines = content.split('\n');

for (const line of lines) {
  const trimmedLine = line.trim();
  if (trimmedLine.startsWith('##') && !trimmedLine.startsWith('###')) {
    const text = trimmedLine.replace(/^#+\s*/, '').replace(/[!?.]+$/, '');
    let slug = text.toLowerCase()
      .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
      .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .trim();
    headings.push({ depth: 2, slug, text });
  }
}

// CSS & Script Variables
const smoothScrollCSS = `html { scroll-behavior: smooth; }`;

// Client-side script for TOC highlighting & anchor links
const clientScript = `
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Add IDs to H2 elements
    const headings = ${JSON.stringify(headings)};
    headings.forEach(h => {
      const els = Array.from(document.querySelectorAll('h2'));
      const target = els.find(el => el.textContent.trim() === h.text);
      if(target) {
        target.id = h.slug;
        target.classList.add('scroll-mt-32'); // Header height offset
      }
    });

    // 2. Intersection Observer for TOC
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('text-orange-400', 'font-bold', 'border-orange-500', 'pl-4'));
          const activeLink = document.querySelector(\`.toc-link[href="#\${entry.target.id}"]\`);
          if(activeLink) activeLink.classList.add('text-orange-400', 'font-bold', 'border-orange-500', 'pl-4');
        }
      });
    }, { rootMargin: '-100px 0px -80% 0px' });

    document.querySelectorAll('h2[id]').forEach(h2 => observer.observe(h2));
  });
`;
---

<Layout title={entry.data.title} description={entry.data.description}>
  <BlogPostingSchema 
    title={entry.data.title} 
    description={entry.data.description} 
    url={currentUrl} 
    pubDate={entry.data.pubDate || entry.data.date} 
    author={entry.data.author}
    image={entry.data.image || entry.data.coverImage}
  />
  
  {entry.data.faqs && (
    <FAQSchema faqs={entry.data.faqs} />
  )}
  <BreadcrumbSchema items={breadcrumbItems} />
  
  <style set:html={smoothScrollCSS}></style>
  <style is:global>
    /* Force white text on orange CTA buttons inside prose */
    .prose a.bg-orange-600 {
      color: #ffffff !important;
      text-decoration: none !important;
    }
    .prose a.bg-orange-600:hover {
      color: #ffffff !important;
    }

    /* Prose Headings Override for Contrast & Proximity */
    .prose h2 {
      color: #E64A19 !important; /* High Contrast Orange */
      margin-bottom: 0.6em !important; /* Gestalt Proximity: Closer to content */
    }
    .prose h2 + p {
        margin-top: 0 !important; /* Tighten the gap */
    }

    /* Sidebar Typography */
    .sidebar-title {
      font-family: "ManifoldExtended", sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #666;
    }

    .sidebar-link {
      font-family: "Manrope", sans-serif;
      font-size: 16px;
      font-weight: 450;
      line-height: 1.8;
      color: #2a2a2a;
      transition: color 0.2s ease, padding-left 0.2s ease;
      display: block;
    }

    .sidebar-link:hover {
      color: #FF5722;
      padding-left: 8px;
    }

    /* Sidebar CTA Card */
    .sidebar-cta-card {
      background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
      border: 1px solid #FFECB3;
    }
    .sidebar-cta-card h4 {
      font-family: "ManifoldExtended", sans-serif;
      font-size: 18px !important;
      font-weight: 700;
      color: #1a1a1a;
    }
    .sidebar-cta-card p {
      font-family: "Manrope", sans-serif;
      font-size: 14px !important;
      line-height: 1.6;
      color: #555;
    }

    /* Mobile Responsive Tables (Card View) */
    @media (max-width: 768px) {
      .prose table {
        display: block;
        width: 100%;
      }
      .prose thead {
        display: none; /* Hide header on mobile */
      }
      .prose tbody {
        display: block;
      }
      .prose tr {
        display: block;
        background: #f9f9f9;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid #FF5722;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      .prose td {
        display: block;
        padding: 4px 0;
        border: none;
        font-size: 15px;
      }
      /* First cell (usually Item Name) is Title */
      .prose td:first-child {
        font-weight: 700;
        color: #1a1a1a;
        font-size: 16px;
        margin-bottom: 4px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 8px;
      }
      /* Last cell (usually Price) is Highlight */
      .prose td:last-child {
        font-weight: 700;
        color: #FF5722;
        text-align: right;
        margin-top: 8px;
        font-size: 18px;
      }
    }

    /* Breadcrumbs */
    .breadcrumb {
        font-size: 14px !important; /* 12px -> 14px */
        font-weight: 450;
        line-height: 1.5;
        color: #666;
        margin-bottom: 16px;
    }
    .breadcrumb a {
        color: #888;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .breadcrumb a:hover {
        color: #FF5722;
    }
    .breadcrumb-current {
        color: #FF5722;
        font-weight: 600;
    }
  </style>

  <!-- Progress Bar -->
  <div class="fixed top-0 left-0 h-1 bg-orange-500 z-[60] w-0 transition-all duration-200" id="progress-bar"></div>

  <main class="bg-white">
    
    <!-- Article Header (Dark Background for Header Visibility) -->
    <header class="pt-32 pb-20 bg-slate-900 text-white relative overflow-hidden">
      <!-- Background Pattern -->
      <div class="absolute inset-0 bg-[url('/images/pattern.svg')] opacity-5"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-900/90"></div>

      <div class="container mx-auto px-4 max-w-4xl text-center relative z-10">
        
        <div class="container mx-auto px-4 py-4">
        <nav class="breadcrumb flex items-center gap-2 overflow-x-auto whitespace-nowrap pb-2">
            <a href="/">Anasayfa</a>
            <span class="text-slate-300">/</span>
            <a href="/blog">Blog</a>
            <span class="text-slate-300">/</span>
            <span class="breadcrumb-current truncate">{entry.data.title}</span>
        </nav>
    </div>     <!-- Category -->
        <div class="flex items-center justify-center mb-6">
            {(entry.data.categories && entry.data.categories[0]) && (
                <span class="px-4 py-1.5 rounded-full bg-orange-600/20 border border-orange-500/30 text-orange-400 text-[10px] font-button uppercase">
                    {entry.data.categories[0]}
                </span>
            )}
        </div>

        <!-- Title -->
        <h1 class="text-3xl md:text-5xl lg:text-6xl font-heading text-white mb-4 leading-tight">
            {entry.data.title}
        </h1>

        <!-- Description (Optional subtitle) -->
        {entry.data.description && (
            <p class="text-lg text-slate-400 max-w-2xl mx-auto mt-6 leading-relaxed">
                {entry.data.description}
            </p>
        )}

      </div>
    </header>

    <!-- Content Wrapper -->
    <div class="container mx-auto px-4 py-16 relative">
        <div class="grid lg:grid-cols-12 gap-12 items-start">
            
            <!-- Main Content -->
            <div class="lg:col-span-8 lg:col-start-1 xl:col-span-8">
                
                {/* Featured Image */}
                {(entry.data.image || entry.data.coverImage) && (
                    <div class="rounded-2xl overflow-hidden shadow-xl mb-12 aspect-video border border-slate-100">
                        <img 
                            src={entry.data.image || entry.data.coverImage} 
                            alt={entry.data.title}
                            class="w-full h-full object-cover"
                        />
                    </div>
                )}

                {/* Article Body */}
                <article class="prose prose-lg prose-slate max-w-none 
                    prose-headings:font-heading prose-headings:font-normal prose-headings:text-slate-900 prose-headings:scroll-mt-32
                    prose-a:text-orange-600 prose-a:no-underline hover:prose-a:underline
                    prose-img:rounded-2xl prose-img:shadow-lg
                    prose-strong:text-slate-900
                    prose-p:leading-relaxed">
                    <Content />
                </article>

                {/* Tags */}
                {entry.data.tags && (
                    <div class="mt-12 pt-8 border-t border-slate-100">
                        <div class="flex flex-wrap gap-2">
                            {entry.data.tags.map((tag: string) => (
                                <span class="px-3 py-1 bg-slate-50 text-slate-600 rounded-full text-sm font-medium border border-slate-100">
                                    #{tag}
                                </span>
                            ))}
                        </div>
                    </div>
                )}

                {/* In-Article CTA */}
                <div class="mt-16 bg-slate-900 rounded-2xl p-8 md:p-10 text-center relative overflow-hidden group">
                    <div class="absolute inset-0 bg-[url('/images/pattern.svg')] opacity-5 group-hover:scale-105 transition-transform duration-700"></div>
                    <div class="relative z-10">
                        <h3 class="text-2xl md:text-3xl font-heading text-white mb-3">
                            Şimdi Kontrol Ettirin, Masraftan Kurtulun
                        </h3>
                        <p class="text-slate-400 mb-8 max-w-lg mx-auto text-sm md:text-base">
                            Küçük bir ses veya titreşim, büyük bir arızanın habercisi olabilir. Gecikmeden önlem alın.
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center gap-3">
                            <a href="tel:05336157835" class="cta-primary shadow-lg shadow-orange-600/20">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                Ustanıza Danışın
                            </a>
                            <!-- Secondary CTA Removed for Peak-End Rule -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Sidebar (Sticky TOC) -->
            <aside class="hidden lg:block lg:col-span-4 lg:col-start-9 relative h-full">
                <div class="sticky top-32 space-y-8">
                    
                    {/* Table of Contents */}
                    {headings.length > 0 && (
                        <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100">
                            <h3 class="sidebar-title mb-4 flex items-center gap-2 opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-orange-500"></span>
                                İÇİNDEKİLER
                            </h3>
                            <nav class="flex flex-col space-y-3 relative">
                                <!-- Vertical Line -->
                                <div class="absolute left-0 top-2 bottom-2 w-px bg-slate-200"></div>
                                
                                {headings.map(h => (
                                    <a href={`#${h.slug}`} class="toc-link sidebar-link py-1 pl-4 border-l-2 border-transparent -ml-[1px] hover:border-orange-300">
                                        {h.text}
                                    </a>
                                ))}
                            </nav>
                        </div>
                    )}

                    {/* Sidebar CTA */}
                    <div class="sidebar-cta-card rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-white rounded-xl shadow-sm flex items-center justify-center mx-auto mb-4 text-orange-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h4 class="uppercase mb-2">Hızlı Servis İhtiyacı?</h4>
                        <p class="mb-4 uppercase opacity-70">Aracınızla ilgili acil bir durum mu var? 7/24 bize ulaşabilirsiniz.</p>
                        <a href="tel:05336157835" class="cta-primary w-full shadow-lg shadow-orange-600/20">
                            0533 615 78 35
                        </a>
                    </div>

                </div>
            </aside>

        </div>
    </div>

  </main>
  
  <Footer />

  <script set:html={clientScript}></script>
  <script>
      // Reading Progress Bar
      window.addEventListener('scroll', () => {
          const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
          const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          const scrolled = (winScroll / height) * 100;
          const bar = document.getElementById('progress-bar');
          if(bar) bar.style.width = scrolled + "%";
      });
  </script>
</Layout>