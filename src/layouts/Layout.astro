---
import Header from "../components/Header.astro";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "Hyundai, Kia, Toyota, Nissan Özel Servis - Tetik Otomotiv",
} = Astro.props;
---

<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta
      name="google-site-verification"
      content="vemNiR5N4bfi6F1zafaPA8iS6rINmGpuYzK4AO9giWs"
    />
    <title>{title}</title>
    <ViewTransitions />

    <!-- Google Analytics - Deferred to not block LCP -->
    <script is:inline>
      // Defer GA loading until after page is interactive
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }

      function loadGA() {
        var s = document.createElement("script");
        s.src = "https://www.googletagmanager.com/gtag/js?id=G-1ZVX33SCZC";
        s.async = true;
        document.head.appendChild(s);
        gtag("js", new Date());
        gtag("config", "G-1ZVX33SCZC");
      }

      // Load GA after user interaction or 4 seconds
      if (document.readyState === "complete") {
        setTimeout(loadGA, 4000);
      } else {
        window.addEventListener(
          "load",
          function () {
            setTimeout(loadGA, 4000);
          },
          { once: true },
        );
      }
      // Or on first user interaction
      ["mousedown", "keydown", "touchstart", "scroll"].forEach(function (e) {
        document.addEventListener(e, loadGA, { once: true, passive: true });
      });
    </script>

    <!-- Google Fonts - Deferred to prevent render-blocking and CLS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Defer font loading to prevent render-blocking -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@700;800&family=Manrope:wght@400;600;700&display=optional"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@700;800&family=Manrope:wght@400;600;700&display=optional"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@700;800&family=Manrope:wght@400;600;700&display=optional"
        rel="stylesheet"
      />
    </noscript>

    <!-- Page-specific head content (preloads, etc.) -->
    <slot name="head" />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/jpeg"
      sizes="16x16"
      href="/images/favicon/16x16-hyundailogoikon.jpg"
    />
    <link
      rel="icon"
      type="image/jpeg"
      sizes="32x32"
      href="/images/favicon/32x32-hyundailogoikon.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/images/favicon/180x180-hyundailogoikon.jpg"
    />
    <link
      rel="icon"
      type="image/jpeg"
      sizes="192x192"
      href="/images/favicon/192x192-hyundailogoikon.jpg"
    />
    <link
      rel="icon"
      type="image/jpeg"
      sizes="512x512"
      href="/images/favicon/512x512-hyundailogoikon.jpg"
    />
    <!-- Critical CSS for above-the-fold content - Font metrics matched to prevent CLS -->
    <style is:inline>
      /* Font fallback with matched metrics to prevent CLS */
      @font-face {
        font-family: "Kanit-fallback";
        src: local("Arial Black"), local("Arial");
        ascent-override: 105%;
        descent-override: 35%;
        line-height-override: 1.2;
      }
      @font-face {
        font-family: "Manrope-fallback";
        src: local("Arial"), local("Helvetica");
        ascent-override: 100%;
        descent-override: 25%;
        line-height-override: 1.5;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Manrope, "Manrope-fallback", system-ui, sans-serif;
        background: #0f172a;
      }
      .font-heading {
        font-family: Kanit, "Kanit-fallback", system-ui, sans-serif;
      }
      /* Hero section - prevent CLS with fixed dimensions */
      .hero-title {
        font-size: clamp(2.5rem, 5vw, 3.75rem);
        line-height: 1.1;
      }
      .bg-slate-900 {
        background-color: #0f172a;
      }
      .bg-slate-950 {
        background-color: #020617;
      }
      .text-white {
        color: #fff;
      }
      .text-orange-500 {
        color: #f97316;
      }
      .text-red-600 {
        color: #dc2626;
      }
      .container {
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .relative {
        position: relative;
      }
      .absolute {
        position: absolute;
      }
      .fixed {
        position: fixed;
      }
      .inset-0 {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .z-50 {
        z-index: 50;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-center {
        justify-content: center;
      }
      .h-screen {
        height: 100vh;
      }
      .min-h-screen {
        min-height: 100vh;
      }
      .overflow-hidden {
        overflow: hidden;
      }
      .object-cover {
        object-fit: cover;
      }
      .w-full {
        width: 100%;
      }
      /* Mobilde yatay scroll'u engelle - clip sticky'yi bozmaz */
      @media (max-width: 1023px) {
        html,
        body {
          overflow-x: clip;
          max-width: 100vw;
        }
      }
    </style>
  </head>
  <body
    class="font-sans antialiased text-slate-800 bg-slate-900 selection:bg-orange-500 selection:text-white"
  >
    <Header />
    <main transition:animate="slide" style="margin-top: 0; padding-top: 0;">
      <slot />
    </main>

    <script>
      // Defer all animation libraries until well after LCP
      let lenis: any = null;
      let gsapInstance: any = null;
      let ScrollTriggerInstance: any = null;
      let initialized = false;

      // Mobil kontrolü - cache result
      const isMobile = (() => {
        let result: boolean | null = null;
        return () => {
          if (result === null) {
            result = window.innerWidth < 1024 || "ontouchstart" in window;
          }
          return result;
        };
      })();

      async function loadAndInit() {
        if (initialized) return;
        initialized = true;

        // Dynamic import - deferred loading
        const [{ default: Lenis }, { gsap }, { ScrollTrigger }] =
          await Promise.all([
            import("lenis"),
            import("gsap"),
            import("gsap/ScrollTrigger"),
          ]);

        gsapInstance = gsap;
        ScrollTriggerInstance = ScrollTrigger;

        gsap.registerPlugin(ScrollTrigger);

        // ScrollTrigger config - disable auto-refresh to prevent forced reflow
        ScrollTrigger.config({
          ignoreMobileResize: true,
          autoRefreshEvents: "visibilitychange,DOMContentLoaded",
        });

        // Lenis setup - SADECE DESKTOP'TA
        if (!isMobile()) {
          lenis = new Lenis({
            duration: 1.2,
            easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            smoothWheel: true,
          });

          lenis.on("scroll", ScrollTrigger.update);
          gsap.ticker.add((time: number) => lenis?.raf(time * 1000));
          gsap.ticker.lagSmoothing(0);
        }

        // Batch all DOM reads first, then writes - prevents forced reflow
        requestAnimationFrame(() => {
          const revealElements = document.querySelectorAll("[data-reveal]");

          // Use CSS for initial reveal instead of GSAP for better performance
          revealElements.forEach((element) => {
            (element as HTMLElement).style.opacity = "1";
            (element as HTMLElement).style.transform = "translateY(0)";
          });

          // Only use ScrollTrigger for below-fold content
          requestAnimationFrame(() => {
            ScrollTrigger.refresh();
          });
        });
      }

      // Wait longer - 3 seconds after load to ensure LCP is complete
      function deferLoad() {
        if ("requestIdleCallback" in window) {
          (window as any).requestIdleCallback(() => loadAndInit(), {
            timeout: 3000,
          });
        } else {
          setTimeout(loadAndInit, 2500);
        }
      }

      // Start deferred loading after window load
      if (document.readyState === "complete") {
        deferLoad();
      } else {
        window.addEventListener("load", deferLoad, { once: true });
      }

      // ViewTransitions support - optimized to avoid forced reflow
      document.addEventListener("astro:page-load", () => {
        if (ScrollTriggerInstance) {
          ScrollTriggerInstance.getAll().forEach((t: any) => t.kill());
        }
        initialized = false;
        requestAnimationFrame(() => {
          deferLoad();
        });
      });

      document.addEventListener("astro:before-swap", () => {
        if (lenis) {
          lenis.destroy();
          lenis = null;
        }
        if (ScrollTriggerInstance) {
          ScrollTriggerInstance.getAll().forEach((t: any) => t.kill());
        }
      });
    </script>

    <style is:global>
      /* Smooth Page Transitions */
      @keyframes fadeSlideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeSlideOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-8px);
        }
      }

      /* ViewTransitions Custom Animations */
      ::view-transition-old(root) {
        animation: fadeSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      ::view-transition-new(root) {
        animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      /* Smooth transition for all elements */
      ::view-transition-group(*) {
        animation-duration: 0.4s;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Lenis temel stilleri */
      html.lenis,
      html.lenis body {
        height: auto;
      }

      .lenis.lenis-smooth {
        scroll-behavior: auto !important;
      }

      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }

      .lenis.lenis-stopped {
        overflow: hidden;
      }

      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }

      /* Initial state for smooth animations - hidden by default */
      [data-reveal] {
        opacity: 0;
        transform: translateY(10px);
        will-change: transform, opacity;
        transition: none;
      }

      [data-reveal="fade-down"] {
        transform: translateY(-10px);
      }

      [data-reveal="fade-left"] {
        transform: translateX(-15px);
      }

      [data-reveal="fade-right"] {
        transform: translateX(15px);
      }

      [data-reveal="bottom"] {
        transform: translateY(20px);
      }

      .no-js [data-reveal] {
        opacity: 1;
        transform: none;
      }
    </style>

    <noscript>
      <style>
        [data-reveal] {
          opacity: 1 !important;
          transform: none !important;
        }
      </style>
    </noscript>
  </body>
</html>
