---
import Header from "../components/Header.astro";
import { ViewTransitions } from "astro:transitions";
import QuickActionBar from "../components/QuickActionBar.astro";
import StickyPhoneButton from "../components/StickyPhoneButton.astro";
import ScrollProgressBar from "../components/ScrollProgressBar.astro";
import iOSCallSheet from "../components/iOSCallSheet.astro";

interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "Hyundai, Kia, Toyota, Nissan Özel Servis - Tetik Otomotiv",
} = Astro.props;
---

<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta
      name="google-site-verification"
      content="vemNiR5N4bfi6F1zafaPA8iS6rINmGpuYzK4AO9giWs"
    />
    {/* Canonical URL Generating Logic */}
    {
      (() => {
        let canonicalURL = new URL(Astro.url.pathname, Astro.site);
        // Ensure strictly no trailing slash for consistency (unless root)
        if (
          canonicalURL.pathname.length > 1 &&
          canonicalURL.pathname.endsWith("/")
        ) {
          canonicalURL.pathname = canonicalURL.pathname.slice(0, -1);
        }
        return <link rel="canonical" href={canonicalURL.href} />;
      })()
    }
    <title>{title}</title>
    <ViewTransitions />

    <!-- Google Analytics - Deferred to not block LCP -->
    <script is:inline>
      // Defer GA loading until after page is interactive
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }

      function loadGA() {
        var s = document.createElement("script");
        s.src = "https://www.googletagmanager.com/gtag/js?id=G-1ZVX33SCZC";
        s.async = true;
        document.head.appendChild(s);
        gtag("js", new Date());
        gtag("config", "G-1ZVX33SCZC");
      }

      // Load GA after user interaction or 4 seconds
      if (document.readyState === "complete") {
        setTimeout(loadGA, 4000);
      } else {
        window.addEventListener(
          "load",
          function () {
            setTimeout(loadGA, 4000);
          },
          { once: true },
        );
      }
      // Or on first user interaction
      ["mousedown", "keydown", "touchstart", "scroll"].forEach(function (e) {
        document.addEventListener(e, loadGA, { once: true, passive: true });
      });

      // GLOBAL CLICK TRACKING (Gelişmiş Versiyon)
      document.addEventListener(
        "click",
        function (e) {
          const link = e.target.closest("a");
          if (!link) return;

          // Sticky Button kendi takibini yapıyor, onu atla
          if (link.classList.contains("sticky-btn")) return;

          const href = link.href;
          if (!href) return;

          // Tıklanan Yeri (Location) Tespit Etme Fonksiyonu
          const getLocation = (element) => {
            if (element.closest("header") || element.closest("#main-header"))
              return "header";
            if (element.closest("footer")) return "footer";
            if (element.closest("#mobile-menu")) return "mobile_menu";

            // Eğer main içindeki ilk section ise 'hero' varsayalım
            const main = element.closest("main");
            if (main) {
              const sections = main.querySelectorAll("section");
              if (sections.length > 0 && sections[0].contains(element))
                return "hero_section";
            }

            return "page_content"; // Diğer tüm alanlar
          };

          const location = getLocation(link);
          const linkText = link.innerText
            ? link.innerText.trim().substring(0, 50)
            : "icon_only";

          let eventName = "";
          let eventParams = {};

          // 1. Telefon Tıklaması -> Event: phone_click
          if (href.startsWith("tel:")) {
            eventName = "phone_click";
            eventParams = {
              click_location: location, // Örn: header, footer, hero_section
              click_text: linkText, // Örn: "0533...", "Hemen Ara"
              full_action: `phone_${location}`, // Örn: phone_header, phone_footer
              number: href.replace("tel:", ""),
            };
          }
          // 2. WhatsApp Tıklaması -> Event: whatsapp_click
          else if (href.includes("wa.me") || href.includes("whatsapp.com")) {
            eventName = "whatsapp_click";
            eventParams = {
              click_location: location,
              click_text: linkText,
              full_action: `whatsapp_${location}`, // Örn: whatsapp_mobile_menu
            };
          }
          // 3. Harita/Yol Tarifi -> Event: map_click
          else if (
            href.includes("maps.google") ||
            href.includes("google.com/maps")
          ) {
            eventName = "map_click";
            eventParams = {
              click_location: location,
              click_text: linkText,
              full_action: `map_${location}`,
            };
          }

          // Event varsa gönder
          if (eventName && typeof window.gtag !== "undefined") {
            window.gtag("event", eventName, eventParams);
            // Test için konsola da yazalım
            // console.log(`GA Event: ${eventName}`, eventParams);
          }
        },
        { passive: true },
      );
    </script>

    <!-- Google Fonts - Premium Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Saira:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Page-specific head content (preloads, etc.) -->
    <slot name="head" />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/webp"
      sizes="64x64"
      href="/images/favicon/64x64-favicon.webp"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="/images/favicon/64x64-favicon.ico"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/images/favicon/64x64-favicon.ico"
    />
    <link rel="apple-touch-icon" href="/images/favicon/tetikfavicon.png" />
    <!-- Critical CSS for above-the-fold content - Font metrics matched to prevent CLS -->
    <style is:inline>
      /* Font fallback with matched metrics to prevent CLS */
      @font-face {
        font-family: "ManifoldExtended";
        src: url("/fonts/manifold-extended/ManifoldExtendedCF-Bold.woff2")
          format("woff2");
        font-weight: bold;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "ManifoldExtended";
        src: url("/fonts/manifold-extended/ManifoldExtendedCF-Medium.woff2")
          format("woff2");
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Electrolize-fallback";
        src: local("Arial"), local("Helvetica");
        ascent-override: 100%;
        descent-override: 20%;
      }
      @font-face {
        font-family: "Syne-fallback";
        src: local("Arial"), local("Helvetica");
        ascent-override: 100%;
        descent-override: 20%;
      }
      :root {
        --brand-blue: #002c5f;
        --brand-orange: #f97316;
        --brand-red: #eb0a1e;
        --bg-dark: #020617;
        --bg-card: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent-gradient: linear-gradient(135deg, #002c5f 0%, #0284c7 100%);
        --premium-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        scroll-behavior: smooth;
      }
      body {
        font-family: "Manrope", system-ui, sans-serif;
        font-size: 18px;
        line-height: 1.7;
        color: #2a2a2a;
        background: #020617;
      }
      /* Mobile Typography Audit Fixes */
      @media (max-width: 768px) {
        body {
          font-size: 16px !important;
          line-height: 1.75 !important;
        }
      }

      /* Global Link Styles (High Contrast) */
      a {
        color: #e64a19;
        transition: color 0.2s ease;
      }
      a:hover {
        color: #d84315;
      }

      /* Global Headings Mobile Rescale */
      @media (max-width: 768px) {
        h1,
        .h1 {
          font-size: 24px !important;
          line-height: 1.2 !important;
          letter-spacing: -0.01em !important;
          margin-bottom: 16px !important;
        }
        h2,
        .h2 {
          font-size: 20px !important;
          line-height: 1.3 !important;
          margin-bottom: 12px !important;
        }
        h3,
        .h3 {
          font-size: 18px !important;
          line-height: 1.4 !important;
        }
      }

      /* List Hierarchy (Hanging Indent) */
      ol,
      ul {
        padding-left: 24px;
        margin-bottom: 24px;
      }
      ol li,
      ul li {
        padding-left: 8px;
        margin-bottom: 16px;
      }
      /* Ensure nested strong tags break line for readability if needed */
      ol li strong,
      ul li strong {
        display: block;
        margin-bottom: 4px;
        color: #0a0a0a;
      }
      ol li p,
      ul li p {
        margin-top: 8px;
        padding-left: 0;
      }

      /* Lead Text */
      .lead-text {
        font-size: 20px;
        font-weight: 450;
        line-height: 1.65;
        color: #1a1a1a;
      }

      /* Global Headings */
      h1,
      .h1 {
        font-family: "ManifoldExtended", sans-serif;
        font-size: clamp(28px, 5vw, 48px);
        font-weight: 700;
        line-height: 1.1;
        letter-spacing: -0.02em;
        text-transform: uppercase;
      }

      h2,
      .h2 {
        font-family: "ManifoldExtended", sans-serif;
        font-size: clamp(24px, 4vw, 32px);
        font-weight: 600;
        line-height: 1.3;
        letter-spacing: -0.01em;
      }

      h3,
      .h3 {
        font-family: "ManifoldExtended", sans-serif;
        font-size: clamp(20px, 3vw, 24px);
        font-weight: 600;
        line-height: 1.4;
        letter-spacing: 0;
      }

      /* CTA Buttons */
      .cta-primary {
        font-family: "ManifoldExtended", sans-serif;
        font-size: 16px;
        font-weight: 700;
        line-height: 1;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);
        color: #ffffff !important;
        padding: 18px 36px;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      .cta-primary:hover {
        background: linear-gradient(135deg, #e64a19 0%, #d84315 100%);
        letter-spacing: 0.08em;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(255, 87, 34, 0.3);
        color: #ffffff !important;
      }

      @media (max-width: 768px) {
        .cta-primary {
          font-size: 16px;
          padding: 16px 32px;
          width: 100%;
        }
      }

      .cta-secondary {
        font-family: "ManifoldExtended", sans-serif;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.03em;
        background: transparent;
        color: #ff5722;
        border: 2px solid #ff5722;
        padding: 16px 34px;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      .cta-secondary:hover {
        background: #ff5722;
        color: #ffffff !important;
      }
      .font-heading {
        font-family: "ManifoldExtended", system-ui, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .font-hero {
        font-family: "ManifoldExtended", sans-serif;
        font-weight: bold;
        letter-spacing: 0.02em;
      }
      .font-hero-alt {
        font-family: "ManifoldExtended", sans-serif;
        font-weight: 500;
        letter-spacing: 0.03em;
      }

      /* Hero section - prevent CLS with fixed dimensions */
      .hero-title {
        font-size: clamp(2.5rem, 5vw, 3.75rem);
        line-height: 1.1;
      }
      .bg-slate-900 {
        background-color: #0f172a;
      }
      .bg-slate-950 {
        background-color: #020617;
      }
      .text-white {
        color: #fff;
      }
      .text-orange-500 {
        color: #f97316;
      }
      .text-red-600 {
        color: #dc2626;
      }
      .container {
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .relative {
        position: relative;
      }
      .absolute {
        position: absolute;
      }
      .fixed {
        position: fixed;
      }
      .inset-0 {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .z-50 {
        z-index: 50;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-center {
        justify-content: center;
      }
      .h-screen {
        height: 100vh;
      }
      .min-h-screen {
        min-height: 100vh;
      }
      .overflow-hidden {
        overflow: hidden;
      }
      .object-cover {
        object-fit: cover;
      }
      .w-full {
        width: 100%;
      }
      /* Mobilde yatay scroll'u engelle - clip sticky'yi bozmaz */
      @media (max-width: 1023px) {
        html,
        body {
          overflow-x: clip;
          max-width: 100vw;
        }
      }
    </style>
  </head>
  <body
    class="font-sans antialiased text-slate-800 bg-slate-900 selection:bg-orange-500 selection:text-white"
  >
    <ScrollProgressBar />
    <Header />
    <main transition:animate="slide" style="margin-top: 0; padding-top: 0;">
      <slot />
    </main>

    <StickyPhoneButton />
    <iOSCallSheet></iOSCallSheet>
    <QuickActionBar />

    <script>
      // Defer all animation libraries until well after LCP
      let lenis: any = null;
      let gsapInstance: any = null;
      let ScrollTriggerInstance: any = null;
      let initialized = false;

      // Mobil kontrolü - cache result
      const isMobile = (() => {
        let result: boolean | null = null;
        return () => {
          if (result === null) {
            result = window.innerWidth < 1024 || "ontouchstart" in window;
          }
          return result;
        };
      })();

      async function loadAndInit() {
        if (initialized) return;

        // Mobilde ağır animasyon kütüphanelerini HİÇ yükleme
        // Sadece CSS transition'lar çalışsın
        if (isMobile()) {
          initialized = true;
          // Mobilde elementleri görünür yap (JS beklemesinler)
          const revealElements = document.querySelectorAll("[data-reveal]");
          revealElements.forEach((element) => {
            (element as HTMLElement).style.opacity = "1";
            (element as HTMLElement).style.transform = "translateY(0)";
          });
          return;
        }

        initialized = true;

        // Dynamic import - deferred loading (Sadece Desktop)
        const [{ default: Lenis }, { gsap }, { ScrollTrigger }] =
          await Promise.all([
            import("lenis"),
            import("gsap"),
            import("gsap/ScrollTrigger"),
          ]);

        gsapInstance = gsap;
        ScrollTriggerInstance = ScrollTrigger;

        gsap.registerPlugin(ScrollTrigger);

        // ScrollTrigger config - disable auto-refresh to prevent forced reflow
        ScrollTrigger.config({
          ignoreMobileResize: true,
          autoRefreshEvents: "visibilitychange,DOMContentLoaded",
        });

        // Lenis setup - SADECE DESKTOP'TA
        if (!isMobile()) {
          lenis = new Lenis({
            duration: 1.2,
            easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            smoothWheel: true,
          });

          lenis.on("scroll", ScrollTrigger.update);
          gsap.ticker.add((time: number) => lenis?.raf(time * 1000));
          gsap.ticker.lagSmoothing(0);
        }

        // Batch all DOM reads first, then writes - prevents forced reflow
        requestAnimationFrame(() => {
          const revealElements = document.querySelectorAll("[data-reveal]");

          // Use CSS for initial reveal instead of GSAP for better performance
          revealElements.forEach((element) => {
            (element as HTMLElement).style.opacity = "1";
            (element as HTMLElement).style.transform = "translateY(0)";
          });

          // Only use ScrollTrigger for below-fold content
          requestAnimationFrame(() => {
            ScrollTrigger.refresh();
          });
        });
      }

      // Wait longer - 3 seconds after load to ensure LCP is complete
      function deferLoad() {
        if ("requestIdleCallback" in window) {
          (window as any).requestIdleCallback(() => loadAndInit(), {
            timeout: 3000,
          });
        } else {
          setTimeout(loadAndInit, 2500);
        }
      }

      // Start deferred loading after window load
      if (document.readyState === "complete") {
        deferLoad();
      } else {
        window.addEventListener("load", deferLoad, { once: true });
      }

      // ViewTransitions support - optimized to avoid forced reflow
      document.addEventListener("astro:page-load", () => {
        // Scroll'u en üste sıfırla
        window.scrollTo(0, 0);
        if (lenis) {
          lenis.scrollTo(0, { immediate: true });
        }

        if (ScrollTriggerInstance) {
          ScrollTriggerInstance.getAll().forEach((t: any) => t.kill());
        }
        initialized = false;
        requestAnimationFrame(() => {
          deferLoad();
        });
      });

      document.addEventListener("astro:before-swap", () => {
        // Geçiş öncesi scroll'u sıfırla
        window.scrollTo(0, 0);
        if (lenis) {
          lenis.scrollTo(0, { immediate: true });
          lenis.destroy();
          lenis = null;
        }
        if (ScrollTriggerInstance) {
          ScrollTriggerInstance.getAll().forEach((t: any) => t.kill());
        }
      });
    </script>

    <style is:global>
      /* Smooth Page Transitions */
      @keyframes fadeSlideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeSlideOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-8px);
        }
      }

      /* ViewTransitions Custom Animations */
      ::view-transition-old(root) {
        animation: fadeSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      ::view-transition-new(root) {
        animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      /* Mobilde view transition group animasyonunu devre dışı bırak - Performans İçin Kritik */
      @media (min-width: 768px) {
        ::view-transition-group(*) {
          animation-duration: 0.4s;
          animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* Mobilde sadece root animasyonu çalışsın, diğerleri default kalsın */
      @media (max-width: 767px) {
        ::view-transition-group(*) {
          animation: none !important;
        }
        ::view-transition-old(root),
        ::view-transition-new(root) {
          animation-duration: 0.2s; /* Mobilde daha hızlı geçiş */
        }
      }

      /* Lenis temel stilleri */
      html.lenis,
      html.lenis body {
        height: auto;
      }

      .lenis.lenis-smooth {
        scroll-behavior: auto !important;
      }

      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }

      .lenis.lenis-stopped {
        overflow: hidden;
      }

      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }

      /* Initial state for smooth animations - hidden by default */
      [data-reveal] {
        opacity: 0;
        transform: translateY(10px);
        /* will-change mobilde bellek sorununa yol açabilir, kaldırıldı */
        transition: none;
      }

      [data-reveal="fade-down"] {
        transform: translateY(-10px);
      }

      [data-reveal="fade-left"] {
        transform: translateX(-15px);
      }

      [data-reveal="fade-right"] {
        transform: translateX(15px);
      }

      [data-reveal="bottom"] {
        transform: translateY(20px);
      }

      .no-js [data-reveal] {
        opacity: 1;
        transform: none;
      }
    </style>

    <noscript>
      <style>
        [data-reveal] {
          opacity: 1 !important;
          transform: none !important;
        }
      </style>
    </noscript>
  </body>
</html>
